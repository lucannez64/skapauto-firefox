<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkapAuto Mass Test Runner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .controls {
            padding: 30px;
            border-bottom: 1px solid #e5e7eb;
            background: #f9fafb;
        }

        .control-group {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .btn-primary {
            background: #4f46e5;
            color: white;
        }

        .btn-primary:hover {
            background: #4338ca;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .progress-container {
            margin: 20px 0;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            margin-top: 8px;
            font-size: 14px;
            color: #6b7280;
        }

        .results {
            padding: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #4f46e5;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #1f2937;
        }

        .stat-label {
            color: #6b7280;
            font-size: 14px;
            margin-top: 4px;
        }

        .test-results {
            margin-top: 30px;
        }

        .site-result {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.2s;
        }

        .site-result:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .site-result.success {
            border-left: 4px solid #10b981;
            background: #f0fdf4;
        }

        .site-result.error {
            border-left: 4px solid #ef4444;
            background: #fef2f2;
        }

        .site-result.testing {
            border-left: 4px solid #f59e0b;
            background: #fffbeb;
        }

        .site-info {
            flex: 1;
        }

        .site-name {
            font-weight: 600;
            color: #1f2937;
        }

        .site-url {
            font-size: 12px;
            color: #6b7280;
            margin-top: 2px;
        }

        .site-stats {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-left: auto;
        }

        .detection-rate {
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .rate-high { background: #dcfce7; color: #166534; }
        .rate-medium { background: #fef3c7; color: #92400e; }
        .rate-low { background: #fee2e2; color: #991b1b; }

        .field-details {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e5e7eb;
            font-size: 12px;
        }

        .field-item {
            display: inline-block;
            margin: 2px 4px;
            padding: 2px 6px;
            border-radius: 3px;
            background: #f3f4f6;
        }

        .field-item.detected {
            background: #dcfce7;
            color: #166534;
        }

        .field-item.missed {
            background: #fee2e2;
            color: #991b1b;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #e5e7eb;
            border-radius: 50%;
            border-top-color: #4f46e5;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .log-container {
            background: #1f2937;
            color: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .log-success { color: #10b981; }
        .log-error { color: #ef4444; }
        .log-info { color: #60a5fa; }
        .log-warning { color: #f59e0b; }

        .category-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 6px 12px;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .filter-btn.active {
            background: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }

        .export-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç SkapAuto Mass Test Runner</h1>
            <p>Test field detection across popular websites</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <button class="btn btn-primary" id="startTest">üöÄ Start Mass Test</button>
                <button class="btn btn-secondary" id="pauseTest" disabled>‚è∏Ô∏è Pause</button>
                <button class="btn btn-secondary" id="stopTest" disabled>‚èπÔ∏è Stop</button>
                <button class="btn btn-success" id="exportResults" disabled>üì• Export Results</button>
            </div>

            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">Ready to start testing...</div>
            </div>

            <div class="category-filter" id="categoryFilter">
                <button class="filter-btn active" data-category="all">All</button>
                <button class="filter-btn" data-category="social">Social</button>
                <button class="filter-btn" data-category="email">Email</button>
                <button class="filter-btn" data-category="ecommerce">E-commerce</button>
                <button class="filter-btn" data-category="streaming">Streaming</button>
                <button class="filter-btn" data-category="professional">Professional</button>
                <button class="filter-btn" data-category="gaming">Gaming</button>
                <button class="filter-btn" data-category="banking">Banking</button>
                <button class="filter-btn" data-category="media">Media</button>
                <button class="filter-btn" data-category="cloud">Cloud</button>
            </div>
        </div>

        <div class="results">
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-number" id="totalSites">0</div>
                    <div class="stat-label">Total Sites</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="testedSites">0</div>
                    <div class="stat-label">Tested</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="successRate">0%</div>
                    <div class="stat-label">Success Rate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgDetection">0%</div>
                    <div class="stat-label">Avg Detection</div>
                </div>
            </div>

            <div class="test-results" id="testResults">
                <!-- Results will be populated here -->
            </div>

            <div class="log-container" id="logContainer">
                <div class="log-entry log-info">üîß Test runner initialized. Click "Start Mass Test" to begin.</div>
            </div>

            <div class="export-section">
                <h3>Export Options</h3>
                <div class="control-group">
                    <button class="btn btn-secondary" id="exportJSON">üìÑ Export JSON</button>
                    <button class="btn btn-secondary" id="exportCSV">üìä Export CSV</button>
                    <button class="btn btn-secondary" id="copyResults">üìã Copy to Clipboard</button>
                </div>
            </div>
        </div>
    </div>

    <script src="mass-test.js"></script>
    <script>
        // Test runner UI logic
        class TestRunner {
            constructor() {
                this.isRunning = false;
                this.isPaused = false;
                this.currentTest = 0;
                this.results = [];
                this.activeCategory = 'all';
                
                this.initializeUI();
                this.bindEvents();
                this.updateStats();
            }

            initializeUI() {
                document.getElementById('totalSites').textContent = testSites.length;
                this.log('Test runner ready. Extension should be loaded.', 'info');
            }

            bindEvents() {
                document.getElementById('startTest').addEventListener('click', () => this.startTest());
                document.getElementById('pauseTest').addEventListener('click', () => this.pauseTest());
                document.getElementById('stopTest').addEventListener('click', () => this.stopTest());
                document.getElementById('exportResults').addEventListener('click', () => this.exportResults());
                document.getElementById('exportJSON').addEventListener('click', () => this.exportJSON());
                document.getElementById('exportCSV').addEventListener('click', () => this.exportCSV());
                document.getElementById('copyResults').addEventListener('click', () => this.copyResults());

                // Category filters
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        this.activeCategory = e.target.dataset.category;
                        this.filterResults();
                    });
                });
            }

            async startTest() {
                this.isRunning = true;
                this.isPaused = false;
                this.currentTest = 0;
                this.results = [];

                document.getElementById('startTest').disabled = true;
                document.getElementById('pauseTest').disabled = false;
                document.getElementById('stopTest').disabled = false;

                this.log('üöÄ Starting mass test...', 'info');

                const sitesToTest = this.activeCategory === 'all' 
                    ? testSites 
                    : testSites.filter(site => site.type === this.activeCategory);

                for (let i = 0; i < sitesToTest.length && this.isRunning; i++) {
                    if (this.isPaused) {
                        await this.waitForResume();
                    }

                    const site = sitesToTest[i];
                    this.currentTest = i + 1;
                    
                    this.updateProgress(i, sitesToTest.length);
                    this.log(`Testing ${site.name}...`, 'info');
                    
                    // Add site to results with testing status
                    this.addSiteResult(site, 'testing');
                    
                    try {
                        // Open site in new tab for manual testing
                        const testWindow = window.open(site.url, '_blank');
                        
                        // Wait for user to check the site
                        await this.waitForUserInput(site);
                        
                        // Close the test window
                        if (testWindow) testWindow.close();
                        
                    } catch (error) {
                        this.log(`‚ùå Error testing ${site.name}: ${error.message}`, 'error');
                        this.updateSiteResult(site, 'error', { error: error.message });
                    }
                }

                this.completeTest();
            }

            async waitForUserInput(site) {
                return new Promise((resolve) => {
                    const modal = this.createTestModal(site, resolve);
                    document.body.appendChild(modal);
                });
            }

            createTestModal(site, resolve) {
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.8);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                `;

                modal.innerHTML = `
                    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; text-align: center;">
                        <h3 style="margin-bottom: 20px;">Testing: ${site.name}</h3>
                        <p style="margin-bottom: 20px; color: #666;">
                            Check the opened tab for login fields with SkapAuto icons.
                            <br>Count how many fields have the icon vs total login fields.
                        </p>
                        <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 20px;">
                            <input type="number" id="fieldsWithIcons" placeholder="Fields with icons" min="0" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <input type="number" id="totalFields" placeholder="Total fields" min="0" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: center;">
                            <button id="submitSuccess" style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer;">‚úÖ Submit</button>
                            <button id="submitError" style="padding: 10px 20px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer;">‚ùå Error/Skip</button>
                        </div>
                    </div>
                `;

                const submitResult = (status) => {
                    const fieldsWithIcons = parseInt(modal.querySelector('#fieldsWithIcons').value) || 0;
                    const totalFields = parseInt(modal.querySelector('#totalFields').value) || 0;
                    
                    const result = {
                        status,
                        fieldsWithIcons,
                        totalFields,
                        detectionRate: totalFields > 0 ? (fieldsWithIcons / totalFields * 100).toFixed(2) : 0
                    };

                    this.updateSiteResult(site, status, result);
                    this.log(`${status === 'success' ? '‚úÖ' : '‚ùå'} ${site.name}: ${fieldsWithIcons}/${totalFields} fields (${result.detectionRate}%)`, status === 'success' ? 'success' : 'error');
                    
                    document.body.removeChild(modal);
                    resolve(result);
                };

                // Add event listeners after the modal is created
                modal.querySelector('#submitSuccess').addEventListener('click', () => submitResult('success'));
                modal.querySelector('#submitError').addEventListener('click', () => submitResult('error'));

                return modal;
            }

            addSiteResult(site, status) {
                const resultsContainer = document.getElementById('testResults');
                const resultElement = document.createElement('div');
                resultElement.className = `site-result ${status}`;
                resultElement.id = `result-${site.name.replace(/\s+/g, '-')}`;
                
                resultElement.innerHTML = `
                    <div class="site-info">
                        <div class="site-name">${site.name}</div>
                        <div class="site-url">${site.url}</div>
                    </div>
                    <div class="site-stats">
                        ${status === 'testing' ? '<div class="loading"></div>' : ''}
                    </div>
                `;
                
                resultsContainer.appendChild(resultElement);
            }

            updateSiteResult(site, status, data = {}) {
                const resultElement = document.getElementById(`result-${site.name.replace(/\s+/g, '-')}`);
                if (!resultElement) return;

                resultElement.className = `site-result ${status}`;
                
                const statsHtml = status === 'success' 
                    ? `<div class="detection-rate rate-${this.getRateClass(data.detectionRate)}">${data.detectionRate}%</div>
                       <div style="font-size: 12px; color: #666;">${data.fieldsWithIcons}/${data.totalFields}</div>`
                    : status === 'error'
                    ? `<div style="color: #ef4444; font-size: 12px;">Error</div>`
                    : '';

                resultElement.querySelector('.site-stats').innerHTML = statsHtml;
                
                // Store result data
                this.results.push({ site, status, ...data });
                this.updateStats();
            }

            getRateClass(rate) {
                if (rate >= 80) return 'high';
                if (rate >= 50) return 'medium';
                return 'low';
            }

            updateProgress(current, total) {
                const percentage = (current / total) * 100;
                document.getElementById('progressFill').style.width = `${percentage}%`;
                document.getElementById('progressText').textContent = `Testing ${current}/${total} sites (${percentage.toFixed(1)}%)`;
            }

            updateStats() {
                const successful = this.results.filter(r => r.status === 'success').length;
                const total = this.results.length;
                const successRate = total > 0 ? (successful / total * 100).toFixed(1) : 0;
                
                const avgDetection = successful > 0 
                    ? (this.results.filter(r => r.status === 'success').reduce((sum, r) => sum + parseFloat(r.detectionRate), 0) / successful).toFixed(1)
                    : 0;

                document.getElementById('testedSites').textContent = total;
                document.getElementById('successRate').textContent = `${successRate}%`;
                document.getElementById('avgDetection').textContent = `${avgDetection}%`;
            }

            completeTest() {
                this.isRunning = false;
                document.getElementById('startTest').disabled = false;
                document.getElementById('pauseTest').disabled = true;
                document.getElementById('stopTest').disabled = true;
                document.getElementById('exportResults').disabled = false;
                
                this.log('üéâ Mass test completed!', 'success');
                this.updateProgress(this.results.length, this.results.length);
            }

            log(message, type = 'info') {
                const logContainer = document.getElementById('logContainer');
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry log-${type}`;
                logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                logContainer.appendChild(logEntry);
                logContainer.scrollTop = logContainer.scrollHeight;
            }

            exportJSON() {
                const data = {
                    timestamp: new Date().toISOString(),
                    results: this.results,
                    summary: this.generateSummary()
                };
                
                this.downloadFile(JSON.stringify(data, null, 2), 'skap-auto-test-results.json', 'application/json');
            }

            exportCSV() {
                const headers = ['Site', 'URL', 'Type', 'Status', 'Fields with Icons', 'Total Fields', 'Detection Rate'];
                const rows = this.results.map(r => [
                    r.site.name,
                    r.site.url,
                    r.site.type,
                    r.status,
                    r.fieldsWithIcons || 0,
                    r.totalFields || 0,
                    r.detectionRate || 0
                ]);
                
                const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
                this.downloadFile(csv, 'skap-auto-test-results.csv', 'text/csv');
            }

            downloadFile(content, filename, type) {
                const blob = new Blob([content], { type });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            generateSummary() {
                const successful = this.results.filter(r => r.status === 'success');
                const byType = {};
                
                this.results.forEach(r => {
                    if (!byType[r.site.type]) byType[r.site.type] = { total: 0, successful: 0 };
                    byType[r.site.type].total++;
                    if (r.status === 'success') byType[r.site.type].successful++;
                });

                return {
                    totalTested: this.results.length,
                    successful: successful.length,
                    successRate: this.results.length > 0 ? (successful.length / this.results.length * 100).toFixed(2) : 0,
                    averageDetectionRate: successful.length > 0 ? (successful.reduce((sum, r) => sum + parseFloat(r.detectionRate), 0) / successful.length).toFixed(2) : 0,
                    byType
                };
            }
        }

        // Initialize test runner when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new TestRunner();
        });
    </script>
</body>
</html>